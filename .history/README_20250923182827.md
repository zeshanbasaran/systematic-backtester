# Systematic Trading Backtester & Risk Monitor

A production-style framework for designing, simulating, and monitoring systematic trading strategies.  
Includes **data ingestion, strategies, backtesting, risk monitoring, database logging, reporting, and a Streamlit dashboard**.

---

## Features

- **Data Ingestion**  
  - Yahoo Finance OHLCV data (daily or hourly).  
  - Cached in parquet for speed & reproducibility.  

- **Trading Strategies**  
  - Simple Moving Average (SMA) crossover (trend-following).  
  - Bollinger Bands mean-reversion.  
  - Extendable base class for custom strategies.  

- **Backtesting Engine**  
  - Simulates trades over 10+ years.  
  - Supports slippage (bps) & per-share commissions.  
  - Outputs equity curve, PnL, returns, and trade logs.  

- **Performance Metrics**  
  - CAGR, annualized volatility, Sharpe ratio.  
  - Maximum drawdown and drawdown curve.  
  - Parametric & historical Value-at-Risk (VaR).  

- **Risk Monitoring**  
  - Configurable thresholds:  
    - Max Drawdown  
    - VaR(95%)  
    - Annual Volatility  
  - Breach detection & alert logging.  

- **Database & Reporting**  
  - SQLAlchemy models (SQLite/MySQL).  
  - Stores runs, trades, daily PnL, and risk events.  
  - Auto-generated Excel reports + PNG charts.  

- **Streamlit Dashboard**  
  - Interactive UI with strategy parameters, KPIs, equity/drawdown plots.  
  - Tabs for risk monitoring, trade logs, PnL distribution, and (future) DB queries.  
  - Export trades to CSV.  

---

## Project Structure

```bash
systematic-backtester/
├─ README.md
├─ pyproject.toml or requirements.txt
├─ src/
│  ├─ config.py
│  ├─ data/
│  │  └─ loaders.py
│  ├─ strategies/
│  │  ├─ base.py
│  │  ├─ sma_crossover.py
│  │  └─ bollinger_meanrev.py
│  ├─ engine/
│  │  ├─ backtester.py
│  │  └─ metrics.py
│  ├─ risk/
│  │  ├─ risk_metrics.py
│  │  └─ monitor.py
│  ├─ db/
│  │  ├─ models.py
│  │  └─ io.py
│  ├─ reporting/
│  │  ├─ reports.py
│  │  └─ plots.py
│  └─ utils.py
├─ notebooks/  (exploration)
├─ data/       (cached OHLCV)
├─ dashboards/
│  └─ app_streamlit.py
├─ matlab/     (optional: strategy replication)
└─ tests/
   ├─ test_data.py
   ├─ test_strategies.py
   ├─ test_engine.py
   └─ test_risk.py
   ```

---

## Quickstart

### 1. Install Dependencies
```bash
# create a venv (recommended)
python -m venv venv
source venv/bin/activate   # or venv\Scripts\activate on Windows

# install requirements
pip install -r requirements.txt

### 3. Run a Backtest

```bash
from src.config import INIT_CASH
from src.data.loaders import get_price_data
from src.strategies.sma_crossover import sma_crossover
from src.engine.backtester import simulate
from src.engine.metrics import ann_return, sharpe, max_drawdown

df = get_price_data("SPY", "2013-01-01", "2025-01-01", "1d")
pos = sma_crossover(df, short=50, long=200, allow_short=False)
bt  = simulate(df, pos, INIT_CASH)

print("CAGR:", ann_return(bt["returns"], 252))
print("Sharpe:", sharpe(bt["returns"], 252))
print("MaxDD:", max_drawdown(bt["equity"])[0])
```

### Launch Dashboard

```bash
streamlit run dashboards/app_streamlit.py
```

## Dashboard Preview

- Overview: KPIs + equity/drawdown charts.
- Risk: MaxDD, VaR, volatility vs. thresholds with breach alerts.
- Trades: Trade log (timestamp, position, price, cost).
- PnL: Distribution histogram + return time-series.
- DB (future): Will show stored runs and allow queries.

### Dashboard Overview

![Overview](image.png)

#### Backtest Controls (Left Sidebar)

- Strategy: SMA (Simple Moving Average crossover) selected.
- Symbol: SPY (S&P 500 ETF).
- Date Range: 2013/01/01 → 2025/01/01. Covers 12 years of daily data.
- Bar Size: 1d (daily bars).
- Parameters:
    - Short Window = 50 days
    - Long Window = 200 days
    - Allow Short = disabled (only long/flat positions)
- Trading Costs:
    - Slippage = 1 bps (0.01% per trade)
    - Commission = $0.01/share
- Risk Thresholds:
    - Max Drawdown = 20%
    - VaR 95% = 3%
    - Annual Vol = 25%

These settings define the entire backtest environment.

#### KPI Metrics (Top Row)

1. Annual Return: 8.98%
    - Compound annual growth rate (CAGR) of the strategy.
    - Slightly below SPY buy-and-hold historical average (~10%), but still strong.

2. Volatility: 13.76%
    - Annualized standard deviation of returns.
    - Indicates moderate risk exposure.

3. Sharpe Ratio: 0.69
    - Risk-adjusted performance: returns per unit of volatility.
    - 0.5 is decent; >1.0 is strong.

4. Max Drawdown: -33.72%
    - Worst peak-to-trough decline over the test period.
    - Shows that risk thresholds (20% limit) were breached.

#### Equity Curve (Top Chart)

- Plots portfolio value over time starting from $100,000.
- Equity grows steadily but with some flat periods (no trades or stuck in flat position).
- Large dips around 2020 (COVID crash) and smaller pullbacks in 2015, 2018, and 2022.
- Ends near ~$190,000–200,000 after 12 years, consistent with ~9% annual growth.

#### Drawdown Curve (Bottom Chart)

- Shows % losses from the last peak.
- Key drawdowns:
    - ~2015–2016 → -15% range.
    - ~2018 → ~-20%.
    - 2020 (COVID) → -33% (worst).
    - 2022 downturn also significant.
- Blue fill area makes it easy to see time spent underwater.

#### Interpretation

- Strengths:
    - Captures long-term market trends with decent annual return.
    - Keeps volatility under control (~13%).
    - Sharpe is positive, showing risk-adjusted edge.
- Weaknesses:
    - Drawdowns exceed the 20% threshold → risk monitor would trigger alerts.
    - Strategy missed some recoveries (flat periods hurt compounding).
    - Underperforms pure buy-and-hold during strong bull runs.
- Next Steps:
    - Tune SMA windows (e.g., 20/100) to reduce drawdown.
    - Add risk overlays (stop-loss, volatility targeting).
    - Compare vs. Bollinger mean-reversion strategy for diversification.

### Risk

![Risk](image-1.png)

#### Alert Banner

- “Max Drawdown breached — value -33.72% vs limit -20.00%”
    - The system immediately flags that the portfolio lost more than the allowed 20% from peak to trough.
    -  is a hard breach, highlighted in red because it exceeds the configured threshold.
    - Useful in production: it tells you to cut or hedge positions.

#### Risk Metrics (Top Row)

1. Max Drawdown: -33.72%
    - Worst historical loss from peak to valley.
    - Limit: -20%. Breached by -13.72 percentage points (pp).
    - Indicates high downside risk that violates risk policy.

2. VaR 95% (1-day): 1.26%
    - Historical Value-at-Risk: on 95% of days, losses were smaller than -1.26%.
    - Limit: 2.50%.
    - This is within tolerance, shown in green (+1.24 pp to limit).
    - Suggests day-to-day losses are not extreme despite long drawdowns.

3. Annual Volatility: 13.76%
    - Annualized standard deviation of returns.
    - Limit: 25%.
    - Also well within tolerance, green (+11.24 pp to limit).
    - Volatility is controlled, even though drawdowns are deep.

#### Drawdown Over Time (Chart)

- Timeline plot of drawdowns relative to equity peaks.
- Shows how deep and how long the portfolio spent underwater.
- Major episodes:
    - 2015–2016 → ~-15%.
    - 2018 Q4 → ~-20%.
    - 2020 (COVID crash) → worst drawdown of -33%.
    - 2022 bear market → another extended drawdown.
- The blue shaded area highlights time spent below peak; deeper troughs = higher risk.

#### Interpretation

- The portfolio is not too volatile day-to-day, but it suffers from very deep long-term drawdowns.
- Risk controls would shut down or resize this strategy because max drawdown exceeded its limit.
- Action items in real use:
    - Reduce exposure (smaller position sizing).
    - Add stop-loss or risk-parity scaling.
    - Diversify with uncorrelated strategies to smooth equity.

This screen is all about ongoing monitoring:

- Green = within safe range.
- Red = breach that requires attention.

### Trades

![Trades](image-2.png)

#### Trades Log Table

Each row represents a trade execution event (a change in position).

- timestamp → Date of the trade.
  - Example: 2013-10-17 00:00:00 = strategy first enters a position.
- target_w (Target Weight) → The portfolio’s desired position after the trade:
  - 1 = 100% long (fully invested).
  - 0 = flat (no position).
  - -1 = 100% short (if allowed).
- delta_w (Delta Weight) → The change in position relative to prior state:
  - 1 = moved from flat → long (BUY).
  - -1 = moved from long → flat (SELL).
  - If shorting were enabled:
    - flat → short = -1.
    - short → long = +2 (closing short & opening long).
- price → The adjusted close price at trade execution.
  - Example: 140.73 in 2013, 418.44 in 2022, showing market growth.
- cost → Estimated trading cost for that transaction.
  - Includes slippage (bps) and commission ($/share).
  - Example: 18.82 in 2022 means entering/exiting required a cost deduction.

#### Example Interpretations

1. 2013-10-17 → `target_w=1`, `delta_w=1`
   - First entry into the market → long 100% SPY at $140.73.
2. 2015-09-04 → `target_w=0`, `delta_w=-1`
   - Strategy exits (sells entire position) at $161.89.
3. 2016-01-19 → `target_w=0`, `delta_w=-1`
   - Another exit trade, closing out at $159.86.
4. 2020-04-01 → `target_w=0`, `delta_w=-1`
   - Exits during COVID crash → out at $227.56.
5. 2020-07-07 → `target_w=1`, `delta_w=1`
   - Re-enters long after recovery signs, at $291.36.
6. 2022-03-17 → `target_w=0`, `delta_w=-1`
   - Exits again at $418.44 with $18.83 in trade cost.

#### Export Option

- Download Trades CSV → Lets you save the log for external analysis (Excel, Python, SQL).
- Useful for verifying trade timing, debugging slippage assumptions, or linking trades to performance periods.

#### Interpretation

- The SMA crossover system trades infrequently (only ~10 trades over 12 years).
- This confirms it is a slow, trend-following strategy.
- Costs are modest per trade since it’s low frequency, but still accumulate.
- Each trade reflects the model’s reaction to SMA crossovers (golden cross = buy, death cross = sell).

### PnL

![PnL](image-3.png)

#### Top Chart — Returns Distribution (Histogram)

- X-axis: Daily returns (profit/loss as a % of equity).
- Y-axis: Frequency (number of days that return occurred).
- The chart shows:
  - Most returns cluster near 0% (center spike), which is typical for equities.
  - Fat tails extend into both negative (losses) and positive (gains), indicating occasional extreme moves.
  - Example: -10%+ rare crash days (e.g., March 2020 COVID sell-off).

Purpose: reveals the risk profile of daily returns — skewness, kurtosis, and tail risk.

#### Bottom Chart — Time-Series of PnL / Returns

- X-axis: Time (2013–2025).
- Y-axis: Daily return (in decimal form, e.g., 0.1 = +10%).
- The line oscillates around 0, showing daily performance.
- Key observations:
  - Spikes above +20% are likely market rebounds after sharp drops.
  - Deep drops below -20% align with major crises (2015 mini-crash, 2020 COVID crash).
  - The volatility of returns is not constant → some years are stable, others very turbulent.

Purpose: lets you spot when performance was smooth vs. choppy, and link extreme days to historical events.

#### Interpretation

- Risk/Return Balance: Most days are mild, but the fat-tailed distribution confirms exposure to market crashes.
- Volatility Clustering: Periods of high volatility (e.g., 2020) show multiple large swings, while other years are calm.
- Sharpe Impact: Many small positive days + a few large negative days drag the Sharpe ratio down.

#### Why This Matters

- The histogram gives statistical shape of returns → is it normal, fat-tailed, skewed?
- The time-series shows when pain happens → crucial for understanding drawdowns and risk exposure.
- Together, they explain why your Sharpe (0.69) is modest: too many large downside events relative to gains.

### DB

![DB](image-4.png)

#### Current State: “Database (future)”

- The tab is a placeholder — it shows the intended functionality but doesn’t yet display results.
- Message: “Here you could query past runs from the SQL database and display metadata.”

This signals that while trade/run data is already being saved into the SQLite/MySQL database (via io.py + models.py), the dashboard hasn’t yet implemented a front-end query/viewer for it.

#### What It Will Do (Future Functionality)

When fully implemented, this tab could:

1. Query stored runs from the database (runs table).
   - Each run = a backtest with metadata:
     - Strategy name (e.g., SMA / Bollinger).
     - Symbol (e.g., SPY).
     - Start & end dates.
     - Bar size (1d / 1h).
     - Parameters (short/long window, k, etc.).
     - Initial capital.
2. Display summaries of past runs:
   - Equity growth.
   - Key metrics (Sharpe, CAGR, MaxDD).
   - Breaches recorded in risk_events.
3. Allow run selection → click on a run to reload its PnL, trades, and risk profile.
   - Makes results reproducible without re-running the backtest.
4. Support filtering/sorting:
   - By strategy type, time period, or performance metric.
5. Link to reports:
   - Downloadable Excel/PDF report generated at the time of the run.
   - Charts from reports.py.

#### Why This Matters

- Right now, every run is ephemeral — results live only in memory until you export.
- The database gives you a persistent audit trail:
  - Every trade, PnL, and risk event is stored with timestamps.
  - Useful for compliance, debugging, or comparing parameter sweeps.

## Testing

Run unit tests:

```bash
pytest -q
```

Covers:
- Data loading & validation.
- Strategy signal generation.
- Backtester integrity (no lookahead bias).
- Metrics & risk checks.

## Roadmap

 - [ ] Extend strategies (momentum, mean reversion, pairs trading).
 - [ ] Add position sizing models (volatility targeting, Kelly, fixed risk).
 - [ ] Enhance DB tab in dashboard (query past runs).
 - [ ] Add notifications (email/Slack) for risk breaches.
 - [ ] Integrate live trading adapter (optional).

## License

MIT License. Free for personal and commercial use.

## Author
Zeshan Basaran  
📧 zeshan.basaran@gmail.com  
🔗 [LinkedIn](https://www.linkedin.com/in/zeshanbasaran) | [GitHub](https://github.com/zeshanbasaran)
